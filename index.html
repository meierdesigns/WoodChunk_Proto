<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Möbel Clicker-Game</title>
<link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico">
<link rel="stylesheet" href="src/weather.css">
<link rel="stylesheet" href="style.css">

<template id="progress-bar-template">
  <style>
    .progress-bar-outer {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      margin-top: 4px;
    }
    .bar-icon {
      font-size: 20px;
      margin-right: 4px;
    }
    .bar {
      width: 100%;
      height: 24px;
      background: #808080;
      border: 3px solid #000000;
      box-shadow: inset 2px 2px 0px #fff, inset -2px -2px 0px #404040;
      overflow: hidden;
    }
    .bar-inner {
      height: 100%;
      width: 0%;
      transition: width 0.2s ease;
      box-shadow: inset 1px 1px 0px #fff;
      min-width: 0;
      max-width: 100%;
      background: linear-gradient(90deg, #ff0000 0%, #ff4444 100%);
    }
    .bar-inner.forester {
      background: linear-gradient(90deg, #00ff00 0%, #44ff44 100%);
    }
    .bar-inner.carpenter {
      background: linear-gradient(90deg, #ff8800 0%, #ffaa44 100%);
    }
  </style>
  <div class="progress-bar-outer">
    <span class="bar-icon"></span>
    <div class="bar"><div class="bar-inner"></div></div>
  </div>
</template>
</head>
<body>
<div id="gameContainer">
  <div class="topbar-flex">
    <div class="topbar-left">
      <div class="score status"><span class="icon">🪵</span> 0 | <span class="icon">🌲</span> <span id="treeCount">10</span> | <span class="icon">💰</span> 0</div>
      <div class="topbar-progress">
        <progress-bar icon="🪓" value="0" max="10" barClass=""></progress-bar>
        <progress-bar icon="🌱" value="0" max="10" barClass="forester"></progress-bar>
        <progress-bar icon="🪑" value="0" max="40" barClass="carpenter"></progress-bar>
      </div>
    </div>
    <div class="topbar-weather weather-group status">
      <div class="weather-row">
        <span class="weather-icon-current"></span>
        <div class="divider"></div>
        <div class="forecast-section">
          <div class="forecast-text">Forecast</div>
          <div class="forecast-icons">
            <span class="weather-icon-forecast"></span>
          </div>
        </div>
      </div>
      <div class="weather-info">
        <span class="weather-time">00:00</span>
        <span class="weather-season">Summer</span>
      </div>
    </div>
  </div>
  <div id="workerVisuals"></div>
  <div class="button-group" style="flex-direction: column; gap: 20px;">
    <div class="topbar-actions">
      <button id="researchButton" onclick="openResearchModal()">🔬 Forschung</button>
    </div>
    <div>
      <div class="button-section-title">Arbeitsamt</div>
      <div class="button-section">
        <table class="arbeitsamt-table" style="width: 100%; border-collapse: collapse; text-align: center; font-size: 20pt;">
          <thead>
            <tr>
              <th style="text-align: left;">Beruf</th>
              <th>Anzahl</th>
              <th>Kosten</th>
              <th>Aktion</th>
              <th>Werkzeug</th>
              <th>Auto</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>🪓 Holzfäller</td>
              <td><span id="workerCount">1</span></td>
              <td>20💰</td>
              <td><button id="hireWorkerButton">Kaufen</button></td>
              <td><button id="upgradeToolButton" title="Axt verbessern"><span class="icon">🪓</span> Lv. <span id="toolLevelAxe">1</span> (<span id="toolCostAxe">50</span><span class="icon">💰</span>)</button></td>
              <td><button id="autoUpgradeAxeBtn" class="auto-toggle-btn" data-tool="axe" title="Automatische Axt-Upgrades aktivieren/deaktivieren">⚡ Auto</button></td>
            </tr>
            <tr>
              <td>🌱 Förster</td>
              <td><span id="foresterCount">1</span></td>
              <td>25💰</td>
              <td><button id="hireForesterButton">Kaufen</button></td>
              <td><button id="upgradePlantToolButton" title="Pflanzwerkzeug verbessern"><span class="icon">🌿</span> Lv. <span id="toolLevelPlant">1</span> (<span id="toolCostPlant">50</span><span class="icon">💰</span>)</button></td>
              <td><button id="autoUpgradePlantBtn" class="auto-toggle-btn" data-tool="plant" title="Automatische Pflanzwerkzeug-Upgrades aktivieren/deaktivieren">⚡ Auto</button></td>
            </tr>
            <tr>
              <td>🪚 Schreiner</td>
              <td><span id="carpenterCount">0</span></td>
              <td>30💰</td>
              <td><button id="hireCarpenterButton">Kaufen</button></td>
              <td><button id="upgradeCarpenterToolButton" title="Schreinerwerkzeug verbessern"><span class="icon">🔨</span> Lv. <span id="toolLevelCarpenter">1</span> (<span id="toolCostCarpenter">50</span><span class="icon">💰</span>)</button></td>
              <td><button id="autoUpgradeCarpenterBtn" class="auto-toggle-btn" data-tool="carpenter" title="Automatische Schreinerwerkzeug-Upgrades aktivieren/deaktivieren">⚡ Auto</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="width:100%; display:flex; justify-content:center; margin-top:12px; gap: 12px;">
        <!-- Buttons entfernt, da sie jetzt oben stehen -->
      </div>
    </div>
    <div>
      <div class="button-section-title">Möbelbau</div>
      <div class="button-section" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left;">Möbel</th>
              <th>🪵 Kosten</th>
              <th>💰 Ertrag</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>🪑 Stuhl</td>
              <td>10</td>
              <td>15</td>
              <td><button id="chairButton">Bauen</button></td>
            </tr>
            <tr style="display:none" id="tableRow">
              <td>🛋️ Tisch</td>
              <td>20</td>
              <td>40</td>
              <td><button id="tableButton">Bauen</button></td>
            </tr>
            <tr style="display:none" id="cabinetRow">
              <td>🚪 Schrank</td>
              <td>50</td>
              <td>100</td>
              <td><button id="wardrobeButton">Bauen</button></td>
            </tr>
            <tr style="display:none" id="tableFurnitureRow"><td>🍽️ Tisch</td><td>20</td><td>40</td><td><button id="tableFurnitureButton">Bauen</button></td></tr>
            <tr style="display:none" id="wardrobeRow"><td>🚪 Schrank</td><td>50</td><td>100</td><td><button id="wardrobeButton">Bauen</button></td></tr>
            <tr style="display:none" id="bedRow"><td>🛏️ Bett</td><td>60</td><td>120</td><td><button id="bedButton">Bauen</button></td></tr>
            <tr style="display:none" id="shelfRow"><td>📚 Regal</td><td>30</td><td>60</td><td><button id="shelfButton">Bauen</button></td></tr>
            <tr style="display:none" id="dresserRow"><td>🗄️ Kommode</td><td>40</td><td>80</td><td><button id="dresserButton">Bauen</button></td></tr>
            <tr style="display:none" id="sofaRow"><td>🛋️ Sofa</td><td>100</td><td>200</td><td><button id="sofaButton">Bauen</button></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <button id="resetBtn">🔄 Spiel zurücksetzen</button>
  <button id="resetResearchBtn" style="font-size:0.95em;padding:6px 14px;margin-left:8px;">Forschungen zurücksetzen</button>
</div>
<!-- Status Sidecard Button und Sidecard -->
<button id="statusSidecardBtn" style="position:fixed;bottom:32px;right:32px;z-index:2000;font-size:2em;padding:12px 16px;border-radius:50%;background:#222;color:#ffd700;border:2px solid #ffd700;box-shadow:2px 2px 8px #000;cursor:pointer;">🛈</button>
<div id="statusSidecardOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2099;"></div>
<div id="statusSidecard" style="display:none;position:fixed;top:0;right:0;width:340px;max-width:90vw;height:100dvh;max-height:100dvh;background:rgba(30,30,30,0.98);color:#ffd700;z-index:2100;box-shadow:-4px 0 24px #000;border-left:3px solid #ffd700;padding:0 18px 0 24px;overflow-y:auto;transition:right 0.2s;">
  <button id="closeStatusSidecard" style="position:absolute;top:12px;right:18px;font-size:1.5em;background:none;border:none;color:#ffd700;cursor:pointer;">×</button>
  <h2 style="margin-top:0;font-size:1.1em;">Statusmeldungen</h2>
  <ul id="statusList" style="list-style:none;padding:0;margin:0;font-size:0.95em;"></ul>
</div>
<!-- Toast für Statusmeldungen -->
<div id="statusToast" style="display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#222;color:#ffd700;padding:14px 32px;border-radius:8px;font-size:1em;z-index:3000;box-shadow:0 4px 24px #000;border:2px solid #ffd700;text-align:center;pointer-events:none;opacity:0.97;transition:opacity 0.3s;"></div>
<script src="src/research.js"></script>
<script src="src/weather.js"></script>
<script>
// Funktion zum Formatieren von Zahlen
function formatNumber(num) {
  if (num >= 1000000000) {
    return (num / 1000000000).toFixed(1) + ' Mrd.';
  }
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + ' Mio.';
  }
  if (num >= 1000) {
    return (num / 1000).toFixed(1) + ' Tsd.';
  }
  return num.toString();
}

document.addEventListener('DOMContentLoaded', function() {
let gold = 0, holz = 0, trees = 10;
let workers = 1, foresters = 1, carpenters = 0;
let toolLevel = 1, plantToolLevel = 1, carpenterToolLevel = 1;
let progress = 0;
let foresterProgress = 0;
let carpenterTimer = 0;
let carpenterProgress = 0;
const CARPENTER_MAX = 40;

// Ressourcen global verfügbar machen für das Forschungssystem
window.gold = gold;
window.holz = holz;
window.trees = trees;

console.log('🎮 DEBUG: Hauptspiel initialisiert, Ressourcen global verfügbar gemacht');

// Basis-Preise für Arbeiter
let workerBaseCost = 20;
let foresterBaseCost = 25;
let carpenterBaseCost = 30;

// Preis-Multiplikator (1.5 = 50% teurer pro Kauf)
const PRICE_MULTIPLIER = 1.5;

// Aktuelle Preise berechnen
function calculateWorkerPrice(basePrice, count) {
  return Math.floor(basePrice * Math.pow(PRICE_MULTIPLIER, count));
}

function updateDisplay() {
  // Globale Variablen aktualisieren
  window.gold = gold;
  window.holz = holz;
  window.trees = trees;
  
  document.querySelectorAll('.score').forEach(scoreElem => {
    scoreElem.innerHTML = 
      `<span class="icon">🪵</span> ${formatNumber(holz)} | ` +
      `<span class="icon">🌲</span> <span id="treeCount">${formatNumber(trees)}</span> | ` +
      `<span class="icon">💰</span> ${formatNumber(gold)}`;
  });
  // Update worker counts
  document.getElementById("workerCount").textContent = workers;
  document.getElementById("foresterCount").textContent = foresters;
  document.getElementById("carpenterCount").textContent = carpenters;
  // Preise für normale Arbeiter
  const workerPrice = calculateWorkerPrice(workerBaseCost, workers - 1);
  const foresterPrice = calculateWorkerPrice(foresterBaseCost, foresters - 1);
  const carpenterPrice = calculateWorkerPrice(carpenterBaseCost, carpenters);
  // Tabelle aktualisieren
  document.querySelector('tr:nth-child(1) td:nth-child(3)').textContent = formatNumber(workerPrice) + '💰';
  document.querySelector('tr:nth-child(2) td:nth-child(3)').textContent = formatNumber(foresterPrice) + '💰';
  document.querySelector('tr:nth-child(3) td:nth-child(3)').textContent = formatNumber(carpenterPrice) + '💰';
  // Buttons aktivieren/deaktivieren basierend auf den neuen Preisen
  document.getElementById("hireWorkerButton").disabled = gold < workerPrice;
  document.getElementById("hireForesterButton").disabled = gold < foresterPrice;
  document.getElementById("hireCarpenterButton").disabled = gold < carpenterPrice;
  // Rest der updateDisplay Funktion bleibt gleich
  document.getElementById("toolLevelAxe").innerText = toolLevel;
  document.getElementById("toolLevelPlant").innerText = plantToolLevel;
  document.getElementById("toolLevelCarpenter").innerText = carpenterToolLevel;
  document.getElementById("toolCostAxe").innerText = formatNumber(toolLevel * 50);
  document.getElementById("toolCostPlant").innerText = formatNumber(plantToolLevel * 50);
  document.getElementById("toolCostCarpenter").innerText = formatNumber(carpenterToolLevel * 50);
  document.getElementById("upgradeToolButton").disabled = gold < toolLevel * 50;
  document.getElementById("upgradePlantToolButton").disabled = gold < plantToolLevel * 50;
  document.getElementById("upgradeCarpenterToolButton").disabled = gold < carpenterToolLevel * 50;
  
  // Update auto-upgrade button states
  updateAutoUpgradeButton('axe');
  updateAutoUpgradeButton('plant');
  updateAutoUpgradeButton('carpenter');
  // Möbel-Bauen-Buttons aktivieren/deaktivieren je nach Forschung und Ressourcen
  if (window.researchSystem) {
    const moebelButtons = [
      {id: 'chairButton', research: 'chair', cost: 10},
      {id: 'tableFurnitureButton', research: 'table_furniture', cost: 20},
      {id: 'wardrobeButton', research: 'wardrobe', cost: 50},
      {id: 'bedButton', research: 'bed', cost: 60},
      {id: 'shelfButton', research: 'shelf', cost: 30},
      {id: 'dresserButton', research: 'dresser', cost: 40},
      {id: 'sofaButton', research: 'sofa', cost: 100}
    ];
    moebelButtons.forEach(btn => {
      const button = document.getElementById(btn.id);
      const unlocked = window.researchSystem.research.find(r => r.id === btn.research && r.completed);
      if (button) button.disabled = !(unlocked && holz >= btn.cost);
    });
  }
}

function saveGameToServer() {
  fetch('/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ gold, holz, trees, workers, foresters, carpenters, toolLevel, plantToolLevel, carpenterToolLevel, progress, foresterProgress })
  })
  .then(response => response.json())
  .then(data => {
    // Kein Log mehr beim Speichern
  })
  .catch(error => {
    console.error('Fehler beim Speichern:', error);
  });
}
function loadGameFromServer() {
  fetch('/load')
    .then(res => res.json())
    .then(save => {
      if (save) {
        console.log('Spielstand geladen:', save);
        gold = save.gold; holz = save.holz; trees = save.trees;
        workers = save.workers; foresters = save.foresters; carpenters = save.carpenters;
        toolLevel = save.toolLevel; plantToolLevel = save.plantToolLevel; carpenterToolLevel = save.carpenterToolLevel;
        progress = save.progress || 0;
        foresterProgress = save.foresterProgress || 0;
        // Fortschrittsbalken wiederherstellen
        setAllProgressBars('', progress);
        setAllProgressBars('forester', foresterProgress);
        // Schreiner-Balken ggf. auch
        setAllProgressBars('carpenter', carpenterProgress);
        updateDisplay();
        if (window.updateMoebelVisibility) window.updateMoebelVisibility();
      } else {
        console.log('Kein gespeicherter Spielstand gefunden');
        if (window.updateMoebelVisibility) window.updateMoebelVisibility();
      }
    })
    .catch(error => {
      console.error('Fehler beim Laden:', error);
      if (window.updateMoebelVisibility) window.updateMoebelVisibility();
    });
}

// Füge eine Funktion für die +X-Animation hinzu
function showPlusOneAnimation(targetBar, amount) {
  const anim = document.createElement('div');
  anim.textContent = `+${amount}`;
  anim.style.position = 'absolute';
  anim.style.left = targetBar.getBoundingClientRect().left + window.scrollX + targetBar.offsetWidth - 40 + 'px';
  anim.style.top = targetBar.getBoundingClientRect().top + window.scrollY - 24 + 'px';
  anim.style.fontSize = '20px';
  anim.style.fontFamily = 'Press Start 2P, monospace';
  anim.style.color = '#00ff00';
  anim.style.textShadow = '2px 2px 0 #000';
  anim.style.pointerEvents = 'none';
  anim.style.zIndex = 1000;
  anim.style.transition = 'transform 1.5s cubic-bezier(.4,2,.6,1), opacity 1.5s';
  anim.style.transform = 'translateY(0)';
  anim.style.opacity = '1';
  document.body.appendChild(anim);
  setTimeout(() => {
    anim.style.transform = 'translateY(-40px)';
    anim.style.opacity = '0';
  }, 10);
  setTimeout(() => {
    anim.remove();
  }, 1500);
}

function setAllProgressBars(barClass, value) {
  document.querySelectorAll(`progress-bar[barclass="${barClass}"]`).forEach(bar => {
    bar.setAttribute('value', value);
  });
}

function autoCollect() {
  // Holzfäller
  if (trees > 0 && workers > 0) {
    progress += toolLevel * workers;
    let barWidth = (progress / 10) * 100;
    if (barWidth > 100) barWidth = 100;
    setAllProgressBars('', progress);
    if (progress >= 10) {
      holz += (Math.floor(Math.random() * 11) + 5) * workers;
      trees -= Math.min(trees, workers);
      progress = 0;
      setAllProgressBars('', progress);
      showPlusOneAnimation(document.querySelector('progress-bar[barclass=""]'), (Math.floor(Math.random() * 11) + 5) * workers);
    }
  }
  
  // Förster
  if (foresters > 0) {
    foresterProgress += foresters * plantToolLevel;
    let foresterBarWidth = (foresterProgress / 10) * 100;
    if (foresterBarWidth > 100) foresterBarWidth = 100;
    setAllProgressBars('forester', foresterProgress);
    if (foresterProgress >= 10) {
      trees += foresters * plantToolLevel;
      foresterProgress = 0;
      setAllProgressBars('forester', foresterProgress);
      showPlusOneAnimation(document.querySelector('progress-bar[barclass="forester"]'), foresters * plantToolLevel);
    }
  }
  
  // Schreiner (sehr langsam)
  if (carpenters > 0 && holz >= 10 * carpenters) {
    carpenterProgress += carpenters * carpenterToolLevel;
    setAllProgressBars('carpenter', carpenterProgress);
    
    if (carpenterProgress >= CARPENTER_MAX) {
      holz -= 10 * carpenters;
      gold += 15 * carpenters * carpenterToolLevel;
      carpenterProgress = 0;
      setAllProgressBars('carpenter', carpenterProgress);
      showPlusOneAnimation(document.querySelector('progress-bar[barclass="carpenter"]'), 15 * carpenters * carpenterToolLevel);
    }
  }
  
  gold = Math.max(0, gold);
  holz = Math.max(0, holz);
  trees = Math.max(0, trees);
  updateDisplay();
}

// Auto-upgrade state tracking
const autoUpgradeState = {
  axe: false,
  plant: false,
  carpenter: false
};

// Load auto-upgrade state from localStorage
function loadAutoUpgradeState() {
  const saved = localStorage.getItem('autoUpgradeState');
  if (saved) {
    Object.assign(autoUpgradeState, JSON.parse(saved));
  }
}

// Save auto-upgrade state to localStorage
function saveAutoUpgradeState() {
  localStorage.setItem('autoUpgradeState', JSON.stringify(autoUpgradeState));
}

// Update auto-upgrade button appearance
function updateAutoUpgradeButton(tool) {
  const btn = document.getElementById(`autoUpgrade${tool.charAt(0).toUpperCase() + tool.slice(1)}Btn`);
  if (btn) {
    if (autoUpgradeState[tool]) {
      btn.textContent = '✅ Auto';
      btn.style.background = '#4CAF50';
      btn.style.color = 'white';
    } else {
      btn.textContent = '⚡ Auto';
      btn.style.background = '#f0f0f0';
      btn.style.color = '#333';
    }
  }
}

// Toggle auto-upgrade for a specific tool
function toggleAutoUpgrade(tool) {
  autoUpgradeState[tool] = !autoUpgradeState[tool];
  updateAutoUpgradeButton(tool);
  saveAutoUpgradeState();
  
  // Show feedback
  const status = autoUpgradeState[tool] ? 'aktiviert' : 'deaktiviert';
  const toolName = tool === 'axe' ? 'Axt' : tool === 'plant' ? 'Pflanzwerkzeug' : 'Schreinerwerkzeug';
  showStatusToast(`Automatische ${toolName}-Upgrades ${status}`);
  
  // Add visual feedback
  const btn = document.getElementById(`autoUpgrade${tool.charAt(0).toUpperCase() + tool.slice(1)}Btn`);
  if (btn) {
    btn.style.transform = 'scale(0.95)';
    setTimeout(() => {
      btn.style.transform = 'scale(1)';
    }, 100);
  }
}

function autoUpgrade() {
  if (autoUpgradeState.axe) upgradeTool();
  if (autoUpgradeState.plant) upgradePlantTool();
  if (autoUpgradeState.carpenter) upgradeCarpenterTool();
}

function upgradeTool() {
  const cost = toolLevel * 50;
  if (gold >= cost) {
    gold -= cost;
    toolLevel++;
    updateDisplay();
  }
}
function upgradePlantTool() {
  const cost = plantToolLevel * 50;
  if (gold >= cost) {
    gold -= cost;
    plantToolLevel++;
    updateDisplay();
  }
}
function upgradeCarpenterTool() {
  const cost = carpenterToolLevel * 50;
  if (gold >= cost) {
    gold -= cost;
    carpenterToolLevel++;
    updateDisplay();
  }
}

const btnUpgradeTool = document.getElementById("upgradeToolButton");
if (btnUpgradeTool) btnUpgradeTool.onclick = upgradeTool;
const btnUpgradePlantTool = document.getElementById("upgradePlantToolButton");
if (btnUpgradePlantTool) btnUpgradePlantTool.onclick = upgradePlantTool;
const btnUpgradeCarpenterTool = document.getElementById("upgradeCarpenterToolButton");
if (btnUpgradeCarpenterTool) btnUpgradeCarpenterTool.onclick = upgradeCarpenterTool;

// Kauflogik für Arbeiter aktualisieren
const btnHireWorker = document.getElementById("hireWorkerButton");
if (btnHireWorker) btnHireWorker.onclick = function() {
  const price = calculateWorkerPrice(workerBaseCost, workers - 1);
  if (gold >= price) {
    gold -= price;
    workers++;
    updateDisplay();
  }
};

const btnHireForester = document.getElementById("hireForesterButton");
if (btnHireForester) btnHireForester.onclick = function() {
  const price = calculateWorkerPrice(foresterBaseCost, foresters - 1);
  if (gold >= price) {
    gold -= price;
    foresters++;
    updateDisplay();
  }
};

const btnHireCarpenter = document.getElementById("hireCarpenterButton");
if (btnHireCarpenter) btnHireCarpenter.onclick = function() {
  const price = calculateWorkerPrice(carpenterBaseCost, carpenters);
  if (gold >= price) {
    gold -= price;
    carpenters++;
    updateDisplay();
  }
};

// Möbel-Bauen-Buttons: Korrekte Event-Handler für alle erforschten Möbel
function handleMoebelBauButton(btnId, researchId, holzKosten, goldErtrag) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  btn.onclick = function() {
    if (!window.researchSystem) return;
    const unlocked = window.researchSystem.research.find(r => r.id === researchId && r.completed);
    if (unlocked && holz >= holzKosten) {
      holz -= holzKosten;
      gold += goldErtrag;
      updateDisplay();
    }
  };
}
handleMoebelBauButton('chairButton', 'chair', 10, 15);
handleMoebelBauButton('tableFurnitureButton', 'table_furniture', 20, 40);
handleMoebelBauButton('wardrobeButton', 'wardrobe', 50, 100);
handleMoebelBauButton('bedButton', 'bed', 60, 120);
handleMoebelBauButton('shelfButton', 'shelf', 30, 60);
handleMoebelBauButton('dresserButton', 'dresser', 40, 80);
handleMoebelBauButton('sofaButton', 'sofa', 100, 200);

document.getElementById("resetBtn").onclick = function() {
  gold = 0; holz = 0; trees = 10;
  workers = 1; foresters = 1; carpenters = 0;
  toolLevel = 1; plantToolLevel = 1; carpenterToolLevel = 1;
  progress = 0;
  foresterProgress = 0;
  localStorage.removeItem('research'); // Forschungsfortschritt zurücksetzen
  localStorage.removeItem('autoUpgradeState'); // Auto-upgrade state zurücksetzen
  
  // Reset auto-upgrade state
  autoUpgradeState.axe = false;
  autoUpgradeState.plant = false;
  autoUpgradeState.carpenter = false;
  
  updateDisplay();
  saveGameToServer();
  if (window.updateMoebelVisibility) window.updateMoebelVisibility();
};

// Auto-upgrade button event listeners
document.getElementById('autoUpgradeAxeBtn').onclick = () => toggleAutoUpgrade('axe');
document.getElementById('autoUpgradePlantBtn').onclick = () => toggleAutoUpgrade('plant');
document.getElementById('autoUpgradeCarpenterBtn').onclick = () => toggleAutoUpgrade('carpenter');

// Initialize auto-upgrade system
loadAutoUpgradeState();
updateAutoUpgradeButton('axe');
updateAutoUpgradeButton('plant');
updateAutoUpgradeButton('carpenter');

setInterval(autoCollect, 2000);
setInterval(autoUpgrade, 1000);
setInterval(saveGameToServer, 2000);

// Spiel beim Start laden
loadGameFromServer();
updateDisplay();

// Wetter-Modul initialisieren
weatherModule.initWeather();

// --- Status Sidecard Logik ---
const statusBtn = document.getElementById('statusSidecardBtn');
const sidecard = document.getElementById('statusSidecard');
const closeSidecard = document.getElementById('closeStatusSidecard');
const sidecardOverlay = document.getElementById('statusSidecardOverlay');
// Initiale Position: außerhalb des Bildschirms
sidecard.style.right = '-380px';
sidecard.style.display = 'block';
sidecard.style.transition = 'right 0.3s cubic-bezier(.7,0,.3,1)';

let sidecardOpen = false;

function openSidecard() {
  sidecard.style.right = '0';
  sidecardOpen = true;
  sidecardOverlay.style.display = 'block';
}
function closeSidecardFn() {
  sidecard.style.right = '-380px';
  sidecardOpen = false;
  sidecardOverlay.style.display = 'none';
}
statusBtn.onclick = openSidecard;
closeSidecard.onclick = closeSidecardFn;
sidecardOverlay.onclick = closeSidecardFn;
// ESC schließt Sidecard
window.addEventListener('keydown', e => { if (sidecardOpen && e.key === 'Escape') closeSidecardFn(); });

// Toast-Logik für Statusmeldungen (wird für Fehler genutzt)
function showStatusToast(msg) {
  const toast = document.getElementById('statusToast');
  toast.textContent = msg;
  toast.style.display = 'block';
  toast.style.opacity = '0.97';
  setTimeout(() => { toast.style.opacity = '0'; }, 2200);
  setTimeout(() => { toast.style.display = 'none'; }, 2600);
}

document.getElementById('musicPopoutBtn').onclick = function() {
  window.open('musicplayer.html', 'MusicPlayer', 'width=340,height=120,menubar=no,toolbar=no,location=no,status=no');
};

// --- Möbelbau-Freischaltung nach Forschung ---
// Erweitere die Funktion updateMoebelVisibility für alle Möbelstücke
function updateMoebelVisibility(retryCount = 0) {
  if (!window.researchSystem || !window.researchSystem.research) {
    if (retryCount < 10) {
      console.log(`[Möbelbau] Forschungssystem noch nicht bereit, versuche erneut... (${retryCount+1})`);
      setTimeout(() => updateMoebelVisibility(retryCount + 1), 100);
    } else {
      console.warn('[Möbelbau] Forschungssystem konnte nicht initialisiert werden!');
    }
    return;
  }
  // Zeilen holen
  const tableRow = document.getElementById('tableRow');
  const cabinetRow = document.getElementById('cabinetRow');
  // Forschung prüfen (alt)
  const tableUnlocked = window.researchSystem && window.researchSystem.research.find(r => r.id === 'table' && r.completed);
  const cabinetUnlocked = window.researchSystem && window.researchSystem.research.find(r => r.id === 'cabinet' && r.completed);
  if (tableRow) tableRow.style.display = tableUnlocked ? '' : 'none';
  if (cabinetRow) cabinetRow.style.display = cabinetUnlocked ? '' : 'none';

  // NEU: Für alle Möbelstücke prüfen - KORRIGIERTE IDs
  const moebelIds = [
    {id:'chair', row:'chairRow'},
    {id:'table_furniture', row:'tableFurnitureRow'},
    {id:'wardrobe', row:'wardrobeRow'},
    {id:'bed', row:'bedRow'},
    {id:'shelf', row:'shelfRow'},
    {id:'dresser', row:'dresserRow'},
    {id:'sofa', row:'sofaRow'}
  ];
  
  moebelIds.forEach(m => {
    const row = document.getElementById(m.row);
    if (row) {
      const unlocked = window.researchSystem.research.find(r => (r.id === m.id || r.id === 'furniture') && r.completed);
      row.style.display = unlocked ? '' : 'none';
      console.log(`[Möbelbau] Zeile ${m.row}: ${unlocked ? 'sichtbar' : 'ausgeblendet'} (Forschung abgeschlossen: ${unlocked ? 'true' : 'false'})`);
    }
  });
}
window.updateMoebelVisibility = updateMoebelVisibility;
// Nach Forschung und beim Laden aufrufen
if (window.researchSystem) {
  const origApplyResearchEffects = researchSystem.applyResearchEffects.bind(researchSystem);
  researchSystem.applyResearchEffects = function(research) {
    origApplyResearchEffects(research);
    updateMoebelVisibility();
  };
}
document.addEventListener('DOMContentLoaded', updateMoebelVisibility);

// Auch beim Laden des Spiels aktualisieren
document.addEventListener('DOMContentLoaded', function() {
  // Kurze Verzögerung, um sicherzustellen, dass das Forschungssystem geladen ist
  setTimeout(updateMoebelVisibility, 100);
});

});

class ProgressBar extends HTMLElement {
  constructor() {
    super();
    const template = document.getElementById('progress-bar-template').content.cloneNode(true);
    this.attachShadow({mode: 'open'}).appendChild(template);
  }
  static get observedAttributes() { return ['icon', 'value', 'max', 'barclass']; }
  attributeChangedCallback(name, oldValue, newValue) { this.render(); }
  connectedCallback() { this.render(); }
  render() {
    const icon = this.getAttribute('icon') || '';
    const value = parseFloat(this.getAttribute('value')) || 0;
    const max = parseFloat(this.getAttribute('max')) || 10;
    const barClass = this.getAttribute('barclass') || '';
    const percent = Math.min(100, Math.max(0, (value / max) * 100));
    this.shadowRoot.querySelector('.bar-icon').textContent = icon;
    const barInner = this.shadowRoot.querySelector('.bar-inner');
    barInner.style.width = percent + '%';
    barInner.className = 'bar-inner' + (barClass ? ' ' + barClass : '');
  }
}
customElements.define('progress-bar', ProgressBar);
</script>
<!-- Füge das Forschungs-Modal am Ende des Body-Tags hinzu -->
<div id="researchModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>🔬 Forschung</h2>
      <span class="close-button" onclick="closeResearchModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="research-tabs" style="display:flex;gap:12px;margin-bottom:12px;">
        <button class="tab-button" data-tab="lumberjack" onclick="showResearchTab('lumberjack')">🪓 Holzfäller</button>
        <button class="tab-button" data-tab="forester" onclick="showResearchTab('forester')">🌱 Förster</button>
        <button class="tab-button" data-tab="carpenter" onclick="showResearchTab('carpenter')">🏭 Verarbeitung</button>
      </div>
      <div id="researchLumberjack" class="research-tab-content" style="display:none;"></div>
      <div id="researchForester" class="research-tab-content" style="display:none;"></div>
      <div id="researchCarpenter" class="research-tab-content" style="display:none;"></div>
    </div>
  </div>
</div>



<script>
function showResearchTab(tabName) {
  document.querySelectorAll('.research-tab-content').forEach(tab => {
    tab.style.display = 'none';
  });
  if(tabName==='lumberjack') document.getElementById('researchLumberjack').style.display = 'block';
  if(tabName==='forester') document.getElementById('researchForester').style.display = 'block';
  if(tabName==='carpenter') document.getElementById('researchCarpenter').style.display = 'block';
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
    if(button.getAttribute('data-tab')===tabName) button.classList.add('active');
  });
}
// Forschungen zurücksetzen Button Handler
if (document.getElementById('resetResearchBtn')) {
  document.getElementById('resetResearchBtn').onclick = function() {
    if (window.resetResearch) window.resetResearch();
  };
}
</script>

</body>
</html> 